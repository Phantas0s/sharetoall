version: '2'

services:
  web:
    build:
      context: ./
      dockerfile: ./docker-prod/nginx/Dockerfile
    depends_on:
      - php
    links:
      - letsencrypt
    environment:
      - MY_DOMAIN_NAME=sharetoall.com
    mem_limit: 2g
    cpu_shares: 256
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes_from:
      - letsencrypt

    # web:
    #     build:
    #         context: ./
    #         dockerfile: ./docker/nginx/Dockerfile
    #     image: ${CI_REGISTRY}/${CI_PROJECT_PATH}:web-latest
    #     ports:
    #         - 9090:80
    #     depends_on:
    #         - php
    #     environment:
    #         - VIRTUAL_HOST=sharetoall.com www.sharetoall.com
    #         - VIRTUAL_PORT=80

  php:
    build:
      context: ./
      dockerfile: ./docker/php/Dockerfile-prod
    image: ${CI_REGISTRY}/${CI_PROJECT_PATH}:php-latest
    volumes:
      - /var/run/mysqld/mysqld.sock:/var/run/mysqld/mysqld.sock
      - ./web:/sharetoall/web
      - ./storage:/sharetoall/storage
    depends_on:
      - redis

  redis:
    build:
      context: ./
      dockerfile: ./docker/redis/Dockerfile
    image: ${CI_REGISTRY}/${CI_PROJECT_PATH}:redis-latest

  letsencrypt:
    image: quay.io/letsencrypt/letsencrypt:latest
    command: bash -c "sleep 6 && certbot certonly --standalone -d sharetoall.com --text --agree-tos --email matthieu.cneude@gmail.com --rsa-key-size 4096 --verbose --renew-by-default"
    entrypoint: ""
    volumes:
      - /etc/letsencrypt
      - /var/lib/letsencrypt
    ports:
      - "80"
      - "443"
    environment:
      - TERM=xterm
